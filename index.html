<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ—…è¡Œã®æ€ã„å‡ºãƒãƒƒãƒ—</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{margin:0;height:100%;font-family:sans-serif;}

#searchBar{
  height:4%;
  display:flex;
  background:#fff;
  border-bottom:1px solid #ccc;
}
#searchInput{flex:1;padding:6px;border:none;}
#searchBtn{width:10%;border:none;background:#eee;}

#app{display:flex;height:96%;}
#map{flex:1;}

#sidebar{
  width:320px;
  border-left:1px solid #ccc;
  padding:8px;
  overflow-y:auto;
  display:none;
}

@media(max-width:768px){
  #app{flex-direction:column;}
  #sidebar{width:100%;border-left:none;border-top:1px solid #ccc;height:30%;}
  #map{height:70%;}
}

/* ãƒ”ãƒ³ */
.pin{
  width:22px;
  height:22px;
  border-radius:50% 50% 50% 0;
  transform:rotate(-45deg);
}

/* è©•ä¾¡UI */
.rate span{
  font-size:22px;
  cursor:pointer;
  opacity:0.3;
}
.rate .active{opacity:1;}

.photo{
  width:60px;height:60px;
  object-fit:cover;
  margin:3px;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="searchBar">
  <input id="searchInput" placeholder="åœ°åæ¤œç´¢">
  <button id="searchBtn" onclick="search()">ğŸ”</button>
</div>

<div id="app">
  <div id="map"></div>

  <div id="sidebar">
    <h3>æ€ã„å‡º</h3>

    <input id="placeName" placeholder="å ´æ‰€å"><br><br>

    è©•ä¾¡ï¼š
    <div class="rate" id="rateUI">
      <span data-r="1">ğŸ™‚</span>
      <span data-r="2">ğŸ˜Š</span>
      <span data-r="3">ğŸ˜†</span>
      <span data-r="4">ğŸ¤©</span>
      <span data-r="5">ğŸ‘‘</span>
    </div>

    <br>ã‚¿ã‚°ï¼š
    <div id="tags"></div>

    <br>ã‚³ãƒ¡ãƒ³ãƒˆï¼š
    <textarea id="comment" rows="3"></textarea>

    <br><br>å†™çœŸ(æœ€å¤§5æš):
    <input type="file" multiple accept="image/*" onchange="addPhotos(event)">
    <div id="photos"></div>

    <br>
    <button onclick="savePin()">ä¿å­˜</button>
    <button onclick="deletePin()">å‰Šé™¤</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map=L.map('map').setView([35,135],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let pins=[];
let current=null;
let tempLatLng=null;
let photos=[];
let rate=1;

const tagList=["â™¨ï¸æ¸©æ³‰","ğŸœã‚°ãƒ«ãƒ¡","â›°å±±","ğŸŒŠæµ·","ğŸ¯åŸ","ğŸŒ„çµ¶æ™¯"];
tagList.forEach(t=>{
  tags.innerHTML+=`<label><input type="checkbox" value="${t}">${t}</label><br>`;
});

rateUI.onclick=e=>{
  if(e.target.dataset.r){
    rate=e.target.dataset.r;
    [...rateUI.children].forEach(x=>x.classList.remove("active"));
    e.target.classList.add("active");
  }
};

function pinColor(r){
  if(r==5)return "#FFD700";
  return `rgba(255,0,0,${0.25+0.18*r})`;
}

function createIcon(r){
  return L.divIcon({
    html:`<div class="pin" style="background:${pinColor(r)}"></div>`,
    iconSize:[22,22],
    iconAnchor:[11,22]
  });
}

map.on("click",e=>{
  tempLatLng=e.latlng;
  current=null;
  openSidebar();
});

function openSidebar(){
  sidebar.style.display="block";
}

function savePin(){
  const data={
    latlng:tempLatLng,
    name:placeName.value,
    rate,
    comment:comment.value,
    tags:[...tags.querySelectorAll("input:checked")].map(x=>x.value),
    photos
  };

  if(!current){
    const m=L.marker(tempLatLng,{icon:createIcon(rate)}).addTo(map);
    m.on("click",()=>selectPin(m));
    pins.push({marker:m,data});
    current=pins[pins.length-1];
  }else{
    current.data=data;
    current.marker.setIcon(createIcon(rate));
  }

  localStorage.setItem("travelPins",JSON.stringify(pins.map(p=>p.data)));
}

function selectPin(marker){
  current=pins.find(p=>p.marker===marker);
  const d=current.data;

  placeName.value=d.name;
  comment.value=d.comment;
  rate=d.rate;
  photos=d.photos||[];

  [...rateUI.children].forEach(x=>{
    x.classList.toggle("active",x.dataset.r==rate);
  });

  tags.querySelectorAll("input").forEach(x=>{
    x.checked=d.tags.includes(x.value);
  });

  renderPhotos();
  openSidebar();
}

function deletePin(){
  if(!current)return;
  map.removeLayer(current.marker);
  pins=pins.filter(p=>p!==current);
  localStorage.setItem("travelPins",JSON.stringify(pins.map(p=>p.data)));
  sidebar.style.display="none";
  current=null;
}

function addPhotos(e){
  [...e.target.files].slice(0,5-photos.length).forEach(f=>{
    const r=new FileReader();
    r.onload=()=>{
      photos.push(r.result);
      renderPhotos();
    };
    r.readAsDataURL(f);
  });
}

function renderPhotos(){
  photosDiv.innerHTML="";
  photos.forEach((p,i)=>{
    photosDiv.innerHTML+=`<img src="${p}" class="photo"
      onclick="photos.splice(${i},1);renderPhotos()">`;
  });
}

function search(){
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${searchInput.value}`)
  .then(r=>r.json())
  .then(d=>{
    if(d[0])map.setView([d[0].lat,d[0].lon],11);
  });
}

window.onload=()=>{
  const saved=JSON.parse(localStorage.getItem("travelPins")||"[]");
  saved.forEach(d=>{
    const m=L.marker(d.latlng,{icon:createIcon(d.rate)}).addTo(map);
    m.on("click",()=>selectPin(m));
    pins.push({marker:m,data:d});
  });
};
</script>

</body>
</html>
