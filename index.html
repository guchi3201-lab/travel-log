<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>旅行ピンマップ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

#map {
  height: 100vh;
}

/* ===== 検索バー（地図の上） ===== */
#searchBar {
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  background: white;
  display: flex;
  gap: 6px;
  padding: 6px 8px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}

#searchInput {
  font-size: 16px;
  padding: 6px;
  width: 220px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

#searchBtn {
  font-size: 16px;
  padding: 6px 10px;
  border: none;
  border-radius: 6px;
  background: #4285f4;
  color: white;
}

/* ===== ポップアップ ===== */
.popup {
  width: 240px;
}

.status {
  font-weight: bold;
  margin-bottom: 6px;
}

.popup textarea {
  width: 100%;
  height: 60px;
  font-size: 15px;
}

.photos {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  margin: 6px 0;
}

.photos img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 6px;
}

.popup button {
  width: 100%;
  padding: 8px;
  font-size: 15px;
  margin-top: 6px;
}
</style>
</head>

<body>

<!-- 検索バー -->
<div id="searchBar">
  <input id="searchInput" type="text" placeholder="例：岡山市・太宰府">
  <button id="searchBtn">検索</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ===== 地図 =====
const map = L.map("map").setView([36.5, 138], 6);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18,
  minZoom: 5
}).addTo(map);

// ===== ピン =====
const icons = {
  blue: L.icon({
    iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  }),
  red: L.icon({
    iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  }),
  yellow: L.icon({
    iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/yellow.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  })
};

const states = [
  { key: "blue", text: "未設定" },
  { key: "red", text: "行った！" },
  { key: "yellow", text: "行ってみたい！" }
];

// ===== マップタップで即ピン =====
map.on("click", e => {
  const marker = L.marker(e.latlng, {
    icon: icons.blue
  }).addTo(map);

  marker.stateIndex = 0;
  marker.photos = [];

  marker.on("click", () => {
    marker.stateIndex = (marker.stateIndex + 1) % states.length;
    const state = states[marker.stateIndex];
    marker.setIcon(icons[state.key]);

    marker.bindTooltip(state.text, {
      direction: "top",
      offset: [0, -20]
    }).openTooltip();
  });

  marker.bindPopup(createPopup(marker));
});

// ===== ポップアップ =====
function createPopup(marker) {
  const div = document.createElement("div");
  div.className = "popup";

  const status = document.createElement("div");
  status.className = "status";
  status.textContent = "状態：未設定";

  const textarea = document.createElement("textarea");
  textarea.placeholder = "コメントを書く";

  const photosDiv = document.createElement("div");
  photosDiv.className = "photos";

  function renderPhotos() {
    photosDiv.innerHTML = "";
    marker.photos.forEach(src => {
      const img = document.createElement("img");
      img.src = src;
      photosDiv.appendChild(img);
    });
  }

  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";
  fileInput.multiple = true;

  fileInput.onchange = () => {
    const files = Array.from(fileInput.files).slice(0, 5 - marker.photos.length);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        marker.photos.push(e.target.result);
        renderPhotos();
      };
      reader.readAsDataURL(file);
    });
  };

  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "ピンを削除";
  deleteBtn.onclick = () => map.removeLayer(marker);

  marker.on("click", () => {
    status.textContent = "状態：" + states[marker.stateIndex].text;
  });

  div.appendChild(status);
  div.appendChild(textarea);
  div.appendChild(photosDiv);
  div.appendChild(fileInput);
  div.appendChild(deleteBtn);

  return div;
}

// ===== 検索（全国対応）=====
document.getElementById("searchBtn").onclick = search;
document.getElementById("searchInput").addEventListener("keypress", e => {
  if (e.key === "Enter") search();
});

function search() {
  const q = document.getElementById("searchInput").value;
  if (!q) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=jp`)
    .then(res => res.json())
    .then(data => {
      if (data.length > 0) {
        map.setView([data[0].lat, data[0].lon], 14);
      } else {
        alert("見つかりませんでした");
      }
    });
}
</script>

</body>
</html>
