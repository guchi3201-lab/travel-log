<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒã‚¤ãƒãƒƒãƒ—</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html,body { margin:0; height:100%; }
#app { display:flex; height:100%; }

#map { width:70%; height:100%; }
#side {
  width:30%;
  padding:10px;
  box-sizing:border-box;
  background:#f7f7f7;
  overflow-y:auto;
}

@media(max-width:768px){
  #app{ flex-direction:column; }
  #map{ width:100%; height:60%; }
  #side{ width:100%; height:40%; }
}

.search {
  display:flex;
  gap:5px;
}
.search input{
  flex:9;
  padding:6px;
}
.search button{
  flex:1;
}

.tag-list label{
  display:inline-block;
  margin:3px;
  padding:3px 6px;
  border:1px solid #aaa;
  border-radius:4px;
  font-size:12px;
}

img.thumb{
  width:100%;
  border-radius:6px;
  margin-top:5px;
}
</style>
</head>

<body>
<div id="app">
  <div id="map"></div>

  <div id="side">
    <div class="search">
      <input id="searchInput" placeholder="å ´æ‰€ã‚’æ¤œç´¢">
      <button onclick="searchPlace()">ğŸ”</button>
    </div>

    <hr>

    <button onclick="setMode()">ğŸ“ ãƒ”ãƒ³è¿½åŠ </button>

    <div id="info"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map = L.map('map');
const savedView = JSON.parse(localStorage.getItem('mapView'));
if(savedView){
  map.setView([savedView.lat,savedView.lng], savedView.zoom);
}else{
  map.setView([36.5,138],5);
}

map.on('moveend', ()=>{
  const c = map.getCenter();
  localStorage.setItem('mapView', JSON.stringify({
    lat:c.lat,lng:c.lng,zoom:map.getZoom()
  }));
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let pins = JSON.parse(localStorage.getItem('pins')||'[]');
let addMode=false;

const tags = {
  æ¸©æ³‰:"â™¨ï¸", ç¥ç¤¾:"â›©", åŸ:"ğŸ¯", å±±:"â›°",
  æµ·:"ğŸŒŠ", ã‚°ãƒ«ãƒ¡:"ğŸœ", çµ¶æ™¯:"ğŸ“·"
};

function save(){
  localStorage.setItem('pins',JSON.stringify(pins));
}

function icon(pin){
  const emoji = tags[pin.tag]||"";
  const color = pin.state==="è¡ŒããŸã„"?"yellow":"green";
  return L.divIcon({
    html:`<div style="background:${color};border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:18px">${emoji}</div>`
  });
}

function render(){
  map.eachLayer(l=>{
    if(l instanceof L.Marker) map.removeLayer(l);
  });

  pins.forEach(p=>{
    const m=L.marker([p.lat,p.lng],{icon:icon(p)}).addTo(map);
    m.on('click',()=>showInfo(p));
    p.marker=m;
  });
}

function setMode(){
  addMode=!addMode;
  alert(addMode?"åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¿½åŠ ":"è¿½åŠ çµ‚äº†");
}

map.on('click',e=>{
  if(!addMode) return;
  pins.push({
    id:Date.now(),
    lat:e.latlng.lat,
    lng:e.latlng.lng,
    tag:"",
    state:"è¡ŒããŸã„",
    photo:null
  });
  save(); render();
});

function showInfo(p){
  let html=`
  <h3>ãƒ”ãƒ³æƒ…å ±</h3>

  çŠ¶æ…‹:
  <select onchange="p.state=this.value;save();render()">
    <option ${p.state==="è¡Œã£ãŸ"?"selected":""}>è¡Œã£ãŸ</option>
    <option ${p.state==="è¡ŒããŸã„"?"selected":""}>è¡ŒããŸã„</option>
  </select>

  <h4>ã‚¿ã‚°</h4>
  <div class="tag-list">`;

  Object.keys(tags).forEach(t=>{
    html+=`
    <label>
      <input type="radio" name="tag" ${p.tag===t?"checked":""}
      onchange="p.tag='${t}';save();render()">
      ${t}
    </label>`;
  });

  html+=`</div>

  <h4>å†™çœŸ</h4>
  <input type="file" accept="image/*" onchange="loadPhoto(event,p)">
  ${p.photo?`<img class="thumb" src="${p.photo}">
  <button onclick="p.photo=null;save();showInfo(p)">ğŸ—‘ å‰Šé™¤</button>`:""}

  <hr>
  <button onclick="pins=pins.filter(x=>x.id!==p.id);save();render();document.getElementById('info').innerHTML=''">âŒ ãƒ”ãƒ³å‰Šé™¤</button>
  `;

  document.getElementById('info').innerHTML=html;
}

function loadPhoto(e,p){
  const r=new FileReader();
  r.onload=()=>{ p.photo=r.result; save(); showInfo(p); };
  r.readAsDataURL(e.target.files[0]);
}

async function searchPlace(){
  const q=document.getElementById('searchInput').value;
  const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
  const d=await res.json();
  if(d[0]){
    map.setView([d[0].lat,d[0].lon], q.includes("çœŒ")?8:13);
  }
}

render();
</script>
</body>
</html>
