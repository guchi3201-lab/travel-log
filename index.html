<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ—…è¡Œè¨˜éŒ²ãƒãƒƒãƒ—</title>

<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; font-family:-apple-system,BlinkMacSystemFont,sans-serif; }
#searchBar { display:flex; gap:6px; padding:8px; }
#searchInput { flex:1; font-size:16px; padding:8px; }
#searchBtn { padding:8px 12px; font-size:16px; }

#map { height:48vh; }

#panel {
  position:fixed;
  bottom:0; left:0; right:0;
  background:#fff;
  border-top:1px solid #ccc;
  padding:10px;
  display:none;
  z-index:1000;
  max-height:45vh;
  overflow:auto;
}

button, textarea, input {
  width:100%;
  margin-top:6px;
  font-size:16px;
  padding:8px;
}

#photos {
  display:flex;
  gap:6px;
  overflow-x:auto;
}
#photos img {
  height:80px;
  border-radius:6px;
}

.status {
  font-weight:bold;
  margin-top:4px;
}
</style>
</head>

<body>

<div id="searchBar">
  <input id="searchInput" placeholder="å ´æ‰€ã‚’æ¤œç´¢ï¼ˆä¾‹ï¼šå²¡å±±å¸‚ï¼‰">
  <button id="searchBtn">æ¤œç´¢</button>
</div>

<div id="map"></div>

<div id="panel">
  <div class="status" id="statusText"></div>
  <textarea id="comment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>
  <input id="tags" placeholder="ã‚¿ã‚°ï¼ˆæ¸©æ³‰,ç¥ç¤¾,å±±ï¼‰">
  <input type="file" id="photoInput" multiple accept="image/*">
  <div id="photos"></div>
  <button onclick="toggleStatus()">è¡Œã£ãŸ / è¡ŒããŸã„ åˆ‡æ›¿</button>
  <button onclick="savePin()">ä¿å­˜</button>
  <button onclick="deletePin()">å‰Šé™¤</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map("map").setView([36,138],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let pins = JSON.parse(localStorage.getItem("travelPins")||"[]");
let markers=[];
let currentIndex=null;

function icon(color){
  return L.icon({
    iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
    shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    iconSize:[25,41], iconAnchor:[12,41]
  });
}

function redraw(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  pins.forEach((p,i)=>{
    const m=L.marker(p.latlng,{icon:icon(p.status==="done"?"red":"yellow")}).addTo(map);
    m.on("click",()=>openPanel(i));
    markers.push(m);
  });
}

function openPanel(i){
  currentIndex=i;
  const p=pins[i];
  comment.value=p.comment||"";
  tags.value=p.tags||"";
  statusText.textContent=p.status==="done"?"ğŸ”´ è¡Œã£ãŸ":"ğŸŸ¡ è¡ŒããŸã„";
  photos.innerHTML="";
  (p.photos||[]).forEach(src=>{
    const img=document.createElement("img");
    img.src=src;
    photos.appendChild(img);
  });
  panel.style.display="block";
}

map.on("click",e=>{
  pins.push({latlng:e.latlng,status:"want",comment:"",tags:"",photos:[]});
  saveStorage();
  redraw();
});

function toggleStatus(){
  pins[currentIndex].status = pins[currentIndex].status==="done"?"want":"done";
  statusText.textContent=pins[currentIndex].status==="done"?"ğŸ”´ è¡Œã£ãŸ":"ğŸŸ¡ è¡ŒããŸã„";
  redraw();
}

photoInput.onchange=()=>{
  const files=[...photoInput.files].slice(0,5);
  files.forEach(f=>{
    const r=new FileReader();
    r.onload=e=>{
      pins[currentIndex].photos.push(e.target.result);
      openPanel(currentIndex);
    };
    r.readAsDataURL(f);
  });
};

function savePin(){
  pins[currentIndex].comment=comment.value;
  pins[currentIndex].tags=tags.value;
  saveStorage();
  panel.style.display="none";
}

function deletePin(){
  pins.splice(currentIndex,1);
  saveStorage();
  panel.style.display="none";
  redraw();
}

function saveStorage(){
  localStorage.setItem("travelPins",JSON.stringify(pins));
}

searchBtn.onclick=()=>{
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${searchInput.value}`)
    .then(r=>r.json())
    .then(d=>{ if(d[0]) map.setView([d[0].lat,d[0].lon],13); });
};

redraw();

// PWA
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
