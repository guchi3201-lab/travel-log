<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>æ—…è¡Œã®æ€ã„å‡ºãƒãƒƒãƒ—</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
html, body {
  margin: 0;
  height: 100%;
  font-family: sans-serif;
}

#app {
  display: flex;
  height: 100%;
}

#map {
  flex: 1;
}

#sidebar {
  width: 360px;
  padding: 10px;
  border-left: 1px solid #ccc;
  display: none;
  overflow-y: auto;
}

@media (max-width: 768px) {
  #app {
    flex-direction: column;
  }
  #sidebar {
    width: 100%;
    border-left: none;
    border-top: 1px solid #ccc;
  }
}

#searchBar {
  height: 5%;
  display: flex;
}

#searchInput {
  flex: 1;
  padding: 6px;
}

button {
  padding: 6px;
}

/* ãƒ”ãƒ³ */
.pin {
  width: 22px;
  height: 22px;
  background: red;
  border-radius: 50% 50% 50% 0;
  transform: rotate(-45deg);
}

/* ã‚¿ã‚° */
.tag {
  display: inline-block;
  margin: 4px;
}

.photo {
  width: 60px;
  height: 60px;
  object-fit: cover;
  margin: 4px;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="searchBar">
  <input id="searchInput" placeholder="åœ°åãƒ»ã‚¿ã‚°ã§æ¤œç´¢">
  <button onclick="search()">ğŸ”</button>
</div>

<div id="app">
  <div id="map"></div>

  <div id="sidebar">
    <h3>æ€ã„å‡º</h3>

    <input id="placeName" placeholder="å ´æ‰€åï¼ˆä¾‹ï¼šå¤ªå®°åºœå¤©æº€å®®ï¼‰"><br><br>

    è©•ä¾¡ï¼š
    <div id="rating"></div>

    <br>ã‚¿ã‚°ï¼š
    <div id="tags"></div>

    <br>
    ã‚³ãƒ¡ãƒ³ãƒˆï¼š
    <textarea id="comment" rows="3"></textarea>

    <br><br>
    å†™çœŸï¼ˆæœ€å¤§5æšï¼‰ï¼š
    <input type="file" multiple accept="image/*" onchange="addPhotos(event)">
    <div id="photos"></div>

    <br>
    <button onclick="savePin()">ä¿å­˜</button>
    <button onclick="deletePin()">å‰Šé™¤</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([35, 135], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let pins = [];
let currentPin = null;
let tempLatLng = null;
let photos = [];

const tagList = [
  { key: "æ¸©æ³‰", icon: "â™¨ï¸" },
  { key: "ã‚°ãƒ«ãƒ¡", icon: "ğŸœ" },
  { key: "å±±", icon: "â›°" },
  { key: "æµ·", icon: "ğŸŒŠ" },
  { key: "åŸ", icon: "ğŸ¯" },
  { key: "çµ¶æ™¯", icon: "ğŸŒ„" }
];

const ratingDiv = document.getElementById("rating");
for (let i = 1; i <= 5; i++) {
  ratingDiv.innerHTML += `<label>
    <input type="radio" name="rate" value="${i}">${i}
  </label>`;
}

const tagDiv = document.getElementById("tags");
tagList.forEach(t => {
  tagDiv.innerHTML += `<label class="tag">
    <input type="checkbox" value="${t.key}">${t.icon}${t.key}
  </label>`;
});

map.on("click", e => {
  tempLatLng = e.latlng;
  openSidebar();
});

function createIcon(rate) {
  return L.divIcon({
    html: `<div class="pin" style="background:rgba(255,0,0,${rate/5})"></div>`,
    iconSize: [22,22],
    iconAnchor: [11,22]
  });
}

function openSidebar() {
  document.getElementById("sidebar").style.display = "block";
}

function savePin() {
  const rate = document.querySelector('input[name="rate"]:checked')?.value || 1;
  const tags = [...document.querySelectorAll('#tags input:checked')].map(e=>e.value);

  if (!currentPin) {
    const marker = L.marker(tempLatLng, { icon: createIcon(rate) }).addTo(map);
    marker.on("click", () => selectPin(marker));
    pins.push({ marker, data: {} });
    currentPin = pins[pins.length - 1];
  }

  currentPin.data = {
    latlng: tempLatLng,
    name: placeName.value,
    rate,
    tags,
    comment: comment.value,
    photos
  };

  localStorage.setItem("travelPins", JSON.stringify(pins.map(p=>p.data)));
}

function selectPin(marker) {
  currentPin = pins.find(p => p.marker === marker);
  const d = currentPin.data;
  placeName.value = d.name;
  comment.value = d.comment;
  photos = d.photos || [];
  openSidebar();
}

function deletePin() {
  if (!currentPin) return;
  map.removeLayer(currentPin.marker);
  pins = pins.filter(p => p !== currentPin);
  localStorage.setItem("travelPins", JSON.stringify(pins.map(p=>p.data)));
  currentPin = null;
  document.getElementById("sidebar").style.display = "none";
}

function addPhotos(e) {
  [...e.target.files].slice(0,5-photos.length).forEach(file => {
    const r = new FileReader();
    r.onload = () => {
      photos.push(r.result);
      renderPhotos();
    };
    r.readAsDataURL(file);
  });
}

function renderPhotos() {
  const div = document.getElementById("photos");
  div.innerHTML = "";
  photos.forEach((p,i)=>{
    div.innerHTML += `<img src="${p}" class="photo" onclick="photos.splice(${i},1);renderPhotos()">`;
  });
}

function search() {
  const q = searchInput.value;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`)
    .then(r=>r.json())
    .then(d=>{
      if(d[0]) map.setView([d[0].lat, d[0].lon], 13);
    });
}

window.onload = () => {
  const saved = JSON.parse(localStorage.getItem("travelPins") || "[]");
  saved.forEach(d=>{
    const m = L.marker(d.latlng,{icon:createIcon(d.rate)}).addTo(map);
    m.on("click",()=>selectPin({marker:m,data:d}));
    pins.push({marker:m,data:d});
  });
};
</script>
</body>
</html>
