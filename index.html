<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ€ã„å‡ºãƒãƒƒãƒ—</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  font-family: sans-serif;
}

#searchBar {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  display: flex;
  width: 85%;
}

#searchBar input {
  flex: 9;
  padding: 8px;
  font-size: 16px;
}

#searchBar button {
  flex: 1;
  font-size: 18px;
}

#container {
  display: flex;
  height: 100%;
}

#map {
  width: 70%;
  height: 100%;
}

#info {
  width: 30%;
  padding: 10px;
  box-sizing: border-box;
  background: #f7f7f7;
  overflow-y: auto;
}

@media (max-width: 768px) {
  #container {
    flex-direction: column;
  }
  #map {
    width: 100%;
    height: 60%;
  }
  #info {
    width: 100%;
    height: 40%;
  }
}

.photo {
  width: 100%;
  margin-top: 5px;
  border-radius: 6px;
}
</style>
</head>

<body>

<div id="searchBar">
  <input id="searchInput" placeholder="å ´æ‰€ã‚’æ¤œç´¢ï¼ˆä¾‹ï¼šå²¡å±±ï¼‰">
  <button id="searchBtn">ğŸ”</button>
</div>

<div id="container">
  <div id="map"></div>
  <div id="info">ãƒ”ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ---------- åœ°å›³åˆæœŸåŒ– ---------- */
const savedView = JSON.parse(localStorage.getItem("mapView"));
const map = L.map("map").setView(
  savedView ? [savedView.lat, savedView.lng] : [36.5, 138],
  savedView ? savedView.zoom : 5
);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

map.on("moveend", () => {
  const c = map.getCenter();
  localStorage.setItem("mapView", JSON.stringify({
    lat: c.lat,
    lng: c.lng,
    zoom: map.getZoom()
  }));
});

/* ---------- èµ¤ãƒ”ãƒ³ ---------- */
const redIcon = L.icon({
  iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png",
  iconSize: [32, 32]
});

/* ---------- ãƒ‡ãƒ¼ã‚¿ ---------- */
let pins = JSON.parse(localStorage.getItem("pins") || "[]");
let currentPin = null;
let markers = [];

/* ---------- ä¿å­˜ ---------- */
function savePins() {
  localStorage.setItem("pins", JSON.stringify(pins));
}

/* ---------- æç”» ---------- */
function renderPins() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  pins.forEach(pin => {
    const marker = L.marker([pin.lat, pin.lng], { icon: redIcon }).addTo(map);
    marker.on("click", () => showInfo(pin));
    markers.push(marker);
  });
}

/* ---------- æƒ…å ±æ¬„ ---------- */
function showInfo(pin) {
  currentPin = pin;

  let html = `
    <h3>æ€ã„å‡º</h3>
    <textarea id="comment" rows="4" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ">${pin.comment || ""}</textarea>
    <br><br>
    <input type="file" id="photoInput" multiple>
    <div id="photos"></div>
    <br>
    <button onclick="saveInfo()">ä¿å­˜</button>
    <button onclick="deletePin()">ãƒ”ãƒ³å‰Šé™¤</button>
  `;

  document.getElementById("info").innerHTML = html;

  renderPhotos();

  document.getElementById("photoInput").onchange = e => {
    [...e.target.files].forEach(file => {
      const reader = new FileReader();
      reader.onload = ev => {
        pin.photos.push(ev.target.result);
        savePins();
        renderPhotos();
      };
      reader.readAsDataURL(file);
    });
  };
}

/* ---------- å†™çœŸè¡¨ç¤º ---------- */
function renderPhotos() {
  const box = document.getElementById("photos");
  box.innerHTML = "";

  currentPin.photos.forEach((src, i) => {
    const img = document.createElement("img");
    img.src = src;
    img.className = "photo";
    img.onclick = () => {
      if (confirm("å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        currentPin.photos.splice(i, 1);
        savePins();
        renderPhotos();
      }
    };
    box.appendChild(img);
  });
}

/* ---------- ä¿å­˜ ---------- */
function saveInfo() {
  currentPin.comment = document.getElementById("comment").value;
  savePins();
  alert("ä¿å­˜ã—ã¾ã—ãŸ");
}

/* ---------- å‰Šé™¤ ---------- */
function deletePin() {
  if (!confirm("ãƒ”ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  pins = pins.filter(p => p !== currentPin);
  savePins();
  document.getElementById("info").innerText = "ãƒ”ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„";
  renderPins();
}

/* ---------- ãƒ”ãƒ³è¿½åŠ  ---------- */
map.on("click", e => {
  const pin = {
    lat: e.latlng.lat,
    lng: e.latlng.lng,
    comment: "",
    photos: []
  };
  pins.push(pin);
  savePins();
  renderPins();
});

/* ---------- æ¤œç´¢ ---------- */
function searchPlace() {
  const q = document.getElementById("searchInput").value.trim();
  if (!q) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
    .then(r => r.json())
    .then(d => {
      if (d.length === 0) {
        alert("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
        return;
      }
      map.setView([d[0].lat, d[0].lon], 9);
    });
}

document.getElementById("searchBtn").onclick = searchPlace;
document.getElementById("searchInput").addEventListener("keydown", e => {
  if (e.key === "Enter") searchPlace();
});

/* ---------- åˆæœŸæç”» ---------- */
renderPins();
</script>

</body>
</html>
