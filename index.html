<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ€ã„å‡ºãƒãƒƒãƒ—</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
body {
  margin: 0;
  font-family: sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

header {
  padding: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: #fff;
  z-index: 1000;
}

header h1 {
  margin: 0;
  font-size: 20px;
  white-space: nowrap;
}

#searchBox {
  flex: 1;
  display: flex;
}

#searchInput {
  flex: 1;
  padding: 6px;
  font-size: 16px;
}

#searchBtn {
  padding: 6px 10px;
  font-size: 16px;
  cursor: pointer;
}

#container {
  flex: 1;
  display: flex;
}

#map {
  flex: 7;
}

#info {
  flex: 3;
  border-left: 1px solid #ccc;
  padding: 10px;
  display: none;
  overflow-y: auto;
}

#info textarea {
  width: 100%;
  height: 60px;
}

.photo-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 5px;
  margin-top: 8px;
}

.photo-grid img {
  width: 100%;
  height: 60px;
  object-fit: cover;
  cursor: pointer;
  border-radius: 4px;
}

/* å†™çœŸæ‹¡å¤§ */
#modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

#modal img {
  max-width: 90%;
  max-height: 90%;
}

/* ã‚¹ãƒãƒ›å¯¾å¿œ */
@media (max-width: 768px) {
  #container {
    flex-direction: column;
  }
  #info {
    border-left: none;
    border-top: 1px solid #ccc;
  }
}
</style>
</head>

<body>

<header>
  <h1>æ€ã„å‡º</h1>
  <div id="searchBox">
    <input id="searchInput" placeholder="åœ°åã§æ¤œç´¢" />
    <button id="searchBtn">ğŸ”</button>
  </div>
</header>

<div id="container">
  <div id="map"></div>
  <div id="info">
    <h3>æ€ã„å‡ºãƒ¡ãƒ¢</h3>
    <textarea id="comment"></textarea>
    <br /><br />
    <input type="file" id="photoInput" accept="image/*" multiple />
    <div class="photo-grid" id="photos"></div>
    <br />
    <button id="saveBtn">ä¿å­˜</button>
    <button id="deleteBtn">ãƒ”ãƒ³å‰Šé™¤</button>
  </div>
</div>

<div id="modal" onclick="this.style.display='none'">
  <img id="modalImg" />
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map("map").setView([36, 138], 5);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap",
}).addTo(map);

const redIcon = new L.Icon({
  iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
});

let pins = JSON.parse(localStorage.getItem("pins") || "[]");
let currentIndex = null;
let markers = [];

function savePins() {
  localStorage.setItem("pins", JSON.stringify(pins));
}

function renderPins() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  pins.forEach((p, i) => {
    const marker = L.marker(p.latlng, { icon: redIcon }).addTo(map);
    marker.on("click", () => openInfo(i));
    markers.push(marker);
  });
}

function openInfo(index) {
  currentIndex = index;
  const p = pins[index];
  document.getElementById("info").style.display = "block";
  document.getElementById("comment").value = p.comment || "";
  renderPhotos();
}

function renderPhotos() {
  const box = document.getElementById("photos");
  box.innerHTML = "";
  pins[currentIndex].photos.forEach(src => {
    const img = document.createElement("img");
    img.src = src;
    img.onclick = () => {
      document.getElementById("modalImg").src = src;
      document.getElementById("modal").style.display = "flex";
    };
    box.appendChild(img);
  });
}

map.on("click", e => {
  pins.push({ latlng: e.latlng, comment: "", photos: [] });
  savePins();
  renderPins();
});

document.getElementById("saveBtn").onclick = () => {
  if (currentIndex === null) return;
  pins[currentIndex].comment = document.getElementById("comment").value;
  savePins();
  alert("ä¿å­˜ã—ã¾ã—ãŸ");
};

document.getElementById("deleteBtn").onclick = () => {
  if (currentIndex === null) return;
  pins.splice(currentIndex, 1);
  currentIndex = null;
  document.getElementById("info").style.display = "none";
  savePins();
  renderPins();
};

document.getElementById("photoInput").onchange = e => {
  const files = [...e.target.files].slice(0, 5 - pins[currentIndex].photos.length);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = () => {
      pins[currentIndex].photos.push(reader.result);
      savePins();
      renderPhotos();
    };
    reader.readAsDataURL(file);
  });
};

document.getElementById("searchBtn").onclick = async () => {
  const q = document.getElementById("searchInput").value;
  if (!q) return;
  const res = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`
  );
  const data = await res.json();
  if (data[0]) {
    map.setView([data[0].lat, data[0].lon], 11);
  }
};

renderPins();
</script>

</body>
</html>
