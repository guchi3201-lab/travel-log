<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>旅行ピンマップ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

#map {
  height: 100vh;
}

/* ピン詳細UI */
.popup {
  width: 240px;
}

.popup textarea {
  width: 100%;
  height: 60px;
  font-size: 15px;
}

.photos {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  margin: 6px 0;
}

.photos img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 6px;
}

.popup button {
  width: 100%;
  padding: 8px;
  font-size: 15px;
  margin-top: 6px;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ===== 地図（日本固定）=====
const map = L.map("map", {
  zoomControl: true
}).setView([36.5, 138], 6);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18,
  minZoom: 5
}).addTo(map);

// ===== ピンアイコン =====
const icons = {
  blue: L.icon({
    iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  }),
  red: L.icon({
    iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  }),
  yellow: L.icon({
    iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/yellow.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  })
};

const colors = ["blue", "red", "yellow"];

// ===== マップタップで即ピン =====
map.on("click", e => {
  const marker = L.marker(e.latlng, {
    icon: icons.blue
  }).addTo(map);

  marker.colorIndex = 0;
  marker.photos = [];
  marker.comment = "";

  // ピンタップで色変更
  marker.on("click", () => {
    marker.colorIndex = (marker.colorIndex + 1) % colors.length;
    marker.setIcon(icons[colors[marker.colorIndex]]);
  });

  marker.bindPopup(createPopup(marker));
});

// ===== ピン詳細 =====
function createPopup(marker) {
  const div = document.createElement("div");
  div.className = "popup";

  const textarea = document.createElement("textarea");
  textarea.placeholder = "コメントを書く";
  textarea.value = marker.comment;
  textarea.oninput = () => marker.comment = textarea.value;

  const photosDiv = document.createElement("div");
  photosDiv.className = "photos";

  function renderPhotos() {
    photosDiv.innerHTML = "";
    marker.photos.forEach(src => {
      const img = document.createElement("img");
      img.src = src;
      photosDiv.appendChild(img);
    });
  }

  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";
  fileInput.multiple = true;

  fileInput.onchange = () => {
    const files = Array.from(fileInput.files).slice(0, 5 - marker.photos.length);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        marker.photos.push(e.target.result);
        renderPhotos();
      };
      reader.readAsDataURL(file);
    });
    fileInput.value = "";
  };

  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "ピンを削除";
  deleteBtn.onclick = () => map.removeLayer(marker);

  renderPhotos();

  div.appendChild(textarea);
  div.appendChild(photosDiv);
  div.appendChild(fileInput);
  div.appendChild(deleteBtn);

  return div;
}
</script>

</body>
</html>
