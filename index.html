<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>旅行記録マップ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

/* 検索エリア */
#searchBar {
  display: flex;
  gap: 5px;
  padding: 8px;
}

#searchInput {
  flex: 1;
  font-size: 16px;
  padding: 8px;
}

#searchBtn {
  font-size: 16px;
  padding: 8px 12px;
}

/* 地図 */
#map {
  height: 50vh;
}

/* 編集パネル */
#panel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid #ccc;
  padding: 10px;
  display: none;
  z-index: 1000;
}

textarea, input, button {
  width: 100%;
  font-size: 16px;
  margin-top: 6px;
  padding: 8px;
}
</style>
</head>

<body>

<!-- 検索 -->
<div id="searchBar">
  <input id="searchInput" placeholder="場所を検索（例：岡山市）">
  <button id="searchBtn">検索</button>
</div>

<!-- 地図 -->
<div id="map"></div>

<!-- 編集 -->
<div id="panel">
  <textarea id="comment" placeholder="コメント"></textarea>
  <input id="tags" placeholder="タグ（温泉,神社,山）">
  <button onclick="savePin()">保存</button>
  <button onclick="deletePin()">削除</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map("map").setView([36, 138], 5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let pins = JSON.parse(localStorage.getItem("travelPins") || "[]");
let markers = [];
let currentIndex = null;

function redraw() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  pins.forEach((p, i) => {
    const m = L.marker(p.latlng).addTo(map);
    m.on("click", () => {
      currentIndex = i;
      comment.value = p.comment || "";
      tags.value = p.tags || "";
      panel.style.display = "block";
    });
    markers.push(m);
  });
}

redraw();

// 地図タップで追加
map.on("click", e => {
  pins.push({ latlng: e.latlng, comment: "", tags: "" });
  localStorage.setItem("travelPins", JSON.stringify(pins));
  redraw();
});

// 保存
function savePin() {
  pins[currentIndex].comment = comment.value;
  pins[currentIndex].tags = tags.value;
  localStorage.setItem("travelPins", JSON.stringify(pins));
  panel.style.display = "none";
}

// 削除
function deletePin() {
  pins.splice(currentIndex, 1);
  localStorage.setItem("travelPins", JSON.stringify(pins));
  panel.style.display = "none";
  redraw();
}

// 検索
function doSearch() {
  const q = searchInput.value.trim();
  if (!q) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`)
    .then(r => r.json())
    .then(d => {
      if (d[0]) {
        map.setView([d[0].lat, d[0].lon], 13);
      }
    });
}

searchBtn.onclick = doSearch;
searchInput.addEventListener("keydown", e => {
  if (e.key === "Enter") doSearch();
});
</script>

</body>
</html>
