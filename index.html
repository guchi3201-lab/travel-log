<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ€ã„å‡ºãƒãƒƒãƒ—</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:sans-serif}

/* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
header{
  height:10vh;
  display:flex;
  align-items:center;
  gap:8px;
  padding:0 10px;
  border-bottom:1px solid #ddd;
}
header h1{font-size:16px;margin:0;white-space:nowrap}
#searchInput{flex:1;padding:6px}
#searchBtn{padding:6px 10px}

/* ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
#container{height:90vh;display:flex;flex-direction:column}
#map{height:60%}
#info{
  height:40%;
  padding:10px;
  border-top:1px solid #ddd;
  overflow-y:auto;
  display:none;
}

/* ===== ã‚¿ã‚° ===== */
.tags{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin:6px 0;
}
.tags label{
  border:1px solid #ccc;
  border-radius:4px;
  padding:4px 6px;
  font-size:12px;
  cursor:pointer;
}
.tags input{margin-right:3px}

/* ===== å†™çœŸ ===== */
#photos{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:5px;
}
#photos img{
  width:100%;
  height:60px;
  object-fit:cover;
  border-radius:4px;
  cursor:pointer;
}

/* ===== ãƒ”ãƒ³ä¸Šã®ã‚¿ã‚°è¡¨ç¤º ===== */
.tag-label{
  background:#fff;
  border-radius:8px;
  padding:2px 4px;
  font-size:14px;
  box-shadow:0 0 2px rgba(0,0,0,.3);
  white-space:nowrap;
}

/* ===== PC ===== */
@media(min-width:769px){
  header{height:8vh}
  #container{height:92vh;flex-direction:row}
  #map{width:70%;height:100%}
  #info{width:30%;height:100%;display:block}
}
</style>
</head>

<body>

<header>
  <h1>æ€ã„å‡º</h1>
  <input id="searchInput" placeholder="åœ°åã‚’æ¤œç´¢">
  <button id="searchBtn">ğŸ”</button>
</header>

<div id="container">
  <div id="map"></div>

  <div id="info">
    <h3>æ€ã„å‡ºæƒ…å ±</h3>

    <div class="tags">
      <label><input type="checkbox" value="â™¨">æ¸©æ³‰</label>
      <label><input type="checkbox" value="â›©">ç¥ç¤¾</label>
      <label><input type="checkbox" value="ğŸ¯">åŸ</label>
      <label><input type="checkbox" value="â›°">å±±</label>
      <label><input type="checkbox" value="ğŸŒŠ">æµ·</label>
      <label><input type="checkbox" value="ğŸœ">ã‚°ãƒ«ãƒ¡</label>
      <label><input type="checkbox" value="ğŸŒ…">çµ¶æ™¯</label>
    </div>

    <textarea id="comment" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>

    <input type="file" id="photoInput" accept="image/*" multiple>
    <div id="photos"></div>

    <button id="saveBtn">ä¿å­˜</button>
    <button id="deleteBtn">ãƒ”ãƒ³å‰Šé™¤</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map=L.map("map").setView([35,135],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const redIcon=L.icon({
  iconUrl:"https://maps.google.com/mapfiles/ms/icons/red-dot.png",
  iconSize:[32,32],
  iconAnchor:[16,32]
});

let pins=JSON.parse(localStorage.getItem("pins")||"[]");
let currentPin=null;

function savePins(){
  localStorage.setItem("pins",JSON.stringify(pins));
}

function createTagMarker(pin){
  if(pin.tagMarker){
    map.removeLayer(pin.tagMarker);
  }
  if(!pin.tags || pin.tags.length===0) return;

  pin.tagMarker=L.marker(pin.latlng,{
    icon:L.divIcon({
      className:"",
      html:`<div class="tag-label">${pin.tags.join("")}</div>`,
      iconSize:[1,1],
      iconAnchor:[-10,30]
    }),
    interactive:false
  }).addTo(map);
}

function renderPins(){
  pins.forEach(pin=>{
    const marker=L.marker(pin.latlng,{icon:redIcon}).addTo(map);
    marker.on("click",()=>selectPin(pin));
    pin.marker=marker;
    createTagMarker(pin);
  });
}

function selectPin(pin){
  currentPin=pin;
  document.getElementById("info").style.display="block";
  document.getElementById("comment").value=pin.comment||"";
  document.querySelectorAll(".tags input").forEach(cb=>{
    cb.checked=pin.tags?.includes(cb.value)||false;
  });
  renderPhotos();
}

function renderPhotos(){
  const div=document.getElementById("photos");
  div.innerHTML="";
  (currentPin.photos||[]).forEach(src=>{
    const img=document.createElement("img");
    img.src=src;
    img.onclick=()=>window.open(src);
    div.appendChild(img);
  });
}

map.on("click",e=>{
  const pin={latlng:e.latlng,comment:"",photos:[],tags:[]};
  pins.push(pin);
  const marker=L.marker(e.latlng,{icon:redIcon}).addTo(map);
  marker.on("click",()=>selectPin(pin));
  pin.marker=marker;
  savePins();
  selectPin(pin);
});

document.getElementById("saveBtn").onclick=()=>{
  if(!currentPin)return;
  currentPin.comment=comment.value;
  currentPin.tags=[...document.querySelectorAll(".tags input:checked")].map(cb=>cb.value);
  createTagMarker(currentPin);
  savePins();
};

document.getElementById("deleteBtn").onclick=()=>{
  if(!currentPin)return;
  map.removeLayer(currentPin.marker);
  if(currentPin.tagMarker) map.removeLayer(currentPin.tagMarker);
  pins=pins.filter(p=>p!==currentPin);
  currentPin=null;
  info.style.display="none";
  savePins();
};

document.getElementById("photoInput").onchange=e=>{
  if(!currentPin)return;
  const files=[...e.target.files].slice(0,5);
  currentPin.photos=[];
  files.forEach(f=>{
    const r=new FileReader();
    r.onload=ev=>{
      currentPin.photos.push(ev.target.result);
      renderPhotos();
      savePins();
    };
    r.readAsDataURL(f);
  });
};

document.getElementById("searchBtn").onclick=()=>{
  const q=searchInput.value;
  if(!q)return;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`)
    .then(r=>r.json())
    .then(d=>{
      if(!d[0])return;
      map.setView([d[0].lat,d[0].lon],9);
    });
};

renderPins();
</script>
</body>
</html>
